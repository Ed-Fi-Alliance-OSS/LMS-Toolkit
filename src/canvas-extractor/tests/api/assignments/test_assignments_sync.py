# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

from datetime import datetime
import pytest
from pandas import read_sql_query, DataFrame
from edfi_canvas_extractor.api.assignments import _sync_without_cleanup
from edfi_lms_extractor_lib.api.resource_sync import (
    SYNC_COLUMNS_SQL,
    SYNC_COLUMNS,
    add_hash_and_json_to,
    add_sourceid_to,
)
from tests.api.api_helper import prep_expected_sync_df, prep_from_sync_db_df

IDENTITY_COLUMNS = ["id"]

COLUMNS = [
    "id",
    "description",
    "due_at",
    "unlock_at",
    "lock_at",
    "points_possible",
    "grading_type",
    "assignment_group_id",
    "grading_standard_id",
    "created_at",
    "created_at_date",
    "updated_at",
    "updated_at_date",
    "peer_reviews",
    "automatic_peer_reviews",
    "position",
    "grade_group_students_individually",
    "anonymous_peer_reviews",
    "group_category_id",
    "post_to_sis",
    "moderated_grading",
    "omit_from_final_grade",
    "intra_group_peer_reviews",
    "anonymous_instructor_annotations",
    "anonymous_grading",
    "graders_anonymous_to_graders",
    "grader_count",
    "grader_comments_visible_to_graders",
    "final_grader_id",
    "grader_names_visible_to_final_grader",
    "allowed_attempts",
    "secure_params",
    "course_id",
    "name",
    "submission_types",
    "has_submitted_submissions",
    "due_date_required",
    "max_name_length",
    "in_closed_grading_period",
    "is_quiz_assignment",
    "can_duplicate",
    "original_course_id",
    "original_assignment_id",
    "original_assignment_name",
    "original_quiz_id",
    "workflow_state",
    "muted",
    "html_url",
    "has_overrides",
    "needs_grading_count",
    "sis_assignment_id",
    "integration_id",
    "integration_data",
    "discussion_topic",
    "published",
    "unpublishable",
    "only_visible_to_overrides",
    "locked_for_user",
    "submissions_download_url",
    "post_manually",
    "anonymize_students",
    "require_lockdown_browser",
    "external_tool_tag_attributes",
    "url",
    "quiz_id",
    "anonymous_submissions",
    "use_rubric_for_grading",
    "free_form_criterion_comments",
    "rubric",
    "rubric_settings",
    "due_at_date",
]

CHANGED_ASSIGNMENT_BEFORE = [
    "1",
    "Changed Assignment Before",
    "11",
    "111",
    "1111",
    "2020-11-01",
    "11111",
    "111111",
    "1111111",
    "2020-11-01",
    "11111111",
    "111111111",
    "1111111111",
    "11111111111",
    "111111111111",
    "1111111111111",
    "11111111111111",
    "111111111111111",
    "1111111111111111",
    "11111111111111111",
    "111111111111111111",
    "1111111111111111111",
    "11111111111111111111",
    "111111111111111111111",
    "1111111111111111111111",
    "11111111111111111111111",
    "111111111111111111111111",
    "1111111111111111111111111",
    "11111111111111111111111111",
    "111111111111111111111111111",
    "1111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
]

CHANGED_ASSIGNMENT_AFTER = [
    "1",
    "*Changed Assignment After*",
    "11",
    "111",
    "1111",
    "2020-11-01",
    "11111",
    "111111",
    "1111111",
    "2020-11-01",
    "11111111",
    "111111111",
    "1111111111",
    "11111111111",
    "111111111111",
    "1111111111111",
    "11111111111111",
    "111111111111111",
    "1111111111111111",
    "11111111111111111",
    "111111111111111111",
    "1111111111111111111",
    "11111111111111111111",
    "111111111111111111111",
    "1111111111111111111111",
    "11111111111111111111111",
    "111111111111111111111111",
    "1111111111111111111111111",
    "11111111111111111111111111",
    "111111111111111111111111111",
    "1111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
    "11111111111111111111111111111",
]

UNCHANGED_ASSIGNMENT = [
    "2",
    "Unchanged Assignment",
    "22",
    "222",
    "2222",
    "2020-01-02",
    "22222",
    "222222",
    "2222222",
    "2020-02-02",
    "22222222",
    "222222222",
    "2222222222",
    "22222222222",
    "222222222222",
    "2222222222222",
    "22222222222222",
    "222222222222222",
    "2222222222222222",
    "22222222222222222",
    "222222222222222222",
    "2222222222222222222",
    "22222222222222222222",
    "222222222222222222222",
    "2222222222222222222222",
    "22222222222222222222222",
    "222222222222222222222222",
    "2222222222222222222222222",
    "22222222222222222222222222",
    "222222222222222222222222222",
    "2222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
    "22222222222222222222222222222",
]

OMITTED_FROM_SYNC_ASSIGNMENT = [
    "3",
    "Omitted From Sync Assignment",
    "33",
    "333",
    "3333",
    "2020-01-03",
    "33333",
    "333333",
    "3333333",
    "2020-03-03",
    "33333333",
    "333333333",
    "3333333333",
    "33333333333",
    "333333333333",
    "3333333333333",
    "33333333333333",
    "333333333333333",
    "3333333333333333",
    "33333333333333333",
    "333333333333333333",
    "3333333333333333333",
    "33333333333333333333",
    "333333333333333333333",
    "3333333333333333333333",
    "33333333333333333333333",
    "333333333333333333333333",
    "3333333333333333333333333",
    "33333333333333333333333333",
    "333333333333333333333333333",
    "3333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
    "33333333333333333333333333333",
]

NEW_ASSIGNMENT = [
    "4",
    "New Assignment",
    "44",
    "444",
    "4444",
    "2020-01-04",
    "44444",
    "444444",
    "4444444",
    "2020-04-04",
    "44444444",
    "444444444",
    "4444444444",
    "44444444444",
    "444444444444",
    "4444444444444",
    "44444444444444",
    "444444444444444",
    "4444444444444444",
    "44444444444444444",
    "444444444444444444",
    "4444444444444444444",
    "44444444444444444444",
    "444444444444444444444",
    "4444444444444444444444",
    "44444444444444444444444",
    "444444444444444444444444",
    "4444444444444444444444444",
    "44444444444444444444444444",
    "444444444444444444444444444",
    "4444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
    "44444444444444444444444444444",
]

SYNC_DATA = [CHANGED_ASSIGNMENT_AFTER, UNCHANGED_ASSIGNMENT, NEW_ASSIGNMENT]


def describe_when_testing_sync_with_new_and_missing_and_updated_rows():
    @pytest.fixture
    def test_db_after_sync(test_db_fixture):
        # arrange
        INITIAL_ASSIGNMENT_DATA = [
            CHANGED_ASSIGNMENT_BEFORE,
            UNCHANGED_ASSIGNMENT,
            OMITTED_FROM_SYNC_ASSIGNMENT,
        ]

        assignments_initial_df = DataFrame(INITIAL_ASSIGNMENT_DATA, columns=COLUMNS)
        assignments_initial_df = add_hash_and_json_to(assignments_initial_df)
        add_sourceid_to(assignments_initial_df, IDENTITY_COLUMNS)

        dateToUse = datetime(2020, 9, 14, 12, 0, 0)
        assignments_initial_df["SyncNeeded"] = 0
        assignments_initial_df["CreateDate"] = dateToUse
        assignments_initial_df["LastModifiedDate"] = dateToUse
        assignments_initial_df = assignments_initial_df[SYNC_COLUMNS]

        assignments_sync_df = DataFrame(SYNC_DATA, columns=COLUMNS)

        with test_db_fixture.connect() as con:
            con.execute("DROP TABLE IF EXISTS Assignments")
            con.execute(
                f"""
                CREATE TABLE IF NOT EXISTS Assignments (
                    {SYNC_COLUMNS_SQL}
                )
                """
            )

        assignments_initial_df.to_sql(
            "Assignments", test_db_fixture, if_exists="append", index=False, chunksize=1000
        )

        # act
        _sync_without_cleanup(assignments_sync_df, test_db_fixture)

        return test_db_fixture

    def it_should_have_assignments_table_with_updated_row_and_added_new_row(
        test_db_after_sync,
    ):
        EXPECTED_ASSIGNMENT_DATA_AFTER_SYNC = [
            UNCHANGED_ASSIGNMENT,
            OMITTED_FROM_SYNC_ASSIGNMENT,
            CHANGED_ASSIGNMENT_AFTER,
            NEW_ASSIGNMENT,
        ]
        with test_db_after_sync.connect() as con:
            expected_assignments_df = prep_expected_sync_df(
                DataFrame(EXPECTED_ASSIGNMENT_DATA_AFTER_SYNC, columns=COLUMNS).astype(
                    "string"
                ),
                IDENTITY_COLUMNS,
            )

            assignments_from_db_df = prep_from_sync_db_df(
                read_sql_query("SELECT * from Assignments", con).astype("string"),
                IDENTITY_COLUMNS,
            )

            assert expected_assignments_df.to_csv() == assignments_from_db_df.to_csv()

    def it_should_have_temporary_sync_table_unchanged(test_db_after_sync):
        EXPECTED_SYNC_DATA_AFTER_SYNC = SYNC_DATA
        with test_db_after_sync.connect() as con:
            expected_sync_assignments_df = prep_expected_sync_df(
                DataFrame(EXPECTED_SYNC_DATA_AFTER_SYNC, columns=COLUMNS).astype(
                    "string"
                ),
                IDENTITY_COLUMNS,
            )

            sync_assignments_from_db_df = prep_from_sync_db_df(
                read_sql_query("SELECT * from Sync_Assignments", con).astype("string"),
                IDENTITY_COLUMNS,
            )

            assert expected_sync_assignments_df.to_csv() == sync_assignments_from_db_df.to_csv()

    def it_should_have_temporary_unmatched_table_with_correct_intermediate_rows(
        test_db_after_sync,
    ):
        EXPECTED_UNMATCHED_DATA_AFTER_SYNC = [
            CHANGED_ASSIGNMENT_BEFORE,
            CHANGED_ASSIGNMENT_AFTER,
            OMITTED_FROM_SYNC_ASSIGNMENT,
            NEW_ASSIGNMENT,
        ]
        with test_db_after_sync.connect() as con:
            expected_unmatched_df = prep_expected_sync_df(
                DataFrame(EXPECTED_UNMATCHED_DATA_AFTER_SYNC, columns=COLUMNS).astype(
                    "string"
                ),
                IDENTITY_COLUMNS,
            )

            unmatched_from_db_df = prep_from_sync_db_df(
                read_sql_query("SELECT * from Unmatched_Assignments", con).astype("string"),
                IDENTITY_COLUMNS,
            )

            assert expected_unmatched_df.to_csv() == unmatched_from_db_df.to_csv()
